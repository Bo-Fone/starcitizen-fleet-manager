version: '3.4'
networks:
    app: ~
volumes:
    db: ~
    redis: ~
services:
    php:
        build:
            context: .
            target: build_php
            dockerfile: ./docker/Dockerfile
        hostname: php
#        restart: unless-stopped
        environment:
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - DB_USER=root
            - DB_PASSWORD=root
            - DB_HOST=mariadb
            - DB_PORT=3306
            - DB_NAME=fleet_manager
        networks:
            - app
    apache:
        build:
            context: .
            target: build_apache
            dockerfile: ./docker/Dockerfile
        hostname: apache
#        restart: unless-stopped
        environment:
            - PHP_HANDLER_HOST=php:9000
        networks:
            - app
        ports:
            - 127.0.0.1:8000:80
    mariadb:
        image: mariadb:10.3
        hostname: mariadb
#        restart: unless-stopped
        volumes:
            - db:/var/lib/mysql
        environment:
            - MYSQL_ROOT_PASSWORD=root
            - MYSQL_DATABASE=fleet_manager
        networks:
            - app
        ports:
            - 127.0.0.1:3306:3306
    redis:
        image: redis:5.0-alpine
        hostname: redis
        volumes:
            - redis:/data
        ports:
            - 127.0.0.1:6379:6379
        networks:
            - app
    redis-commander:
        image: rediscommander/redis-commander:latest
        hostname: redis-commander
#        restart: unless-stopped
        environment:
            - REDIS_HOSTS=local:redis:6379
        networks:
            - app
        ports:
            - 127.0.0.1:8081:8081
    varnish:
        image: cooptilleuls/varnish:6.0-alpine
        hostname: varnish
#        restart: unless-stopped
        networks:
            - app
